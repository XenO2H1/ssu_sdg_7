<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoHub - AI & Community Energy Platform</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f7ff;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.85rem 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(37, 99, 235, 0.3);
            border: none;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(37, 99, 235, 0.4);
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-in-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .tab { transition: all 0.3s ease; }
        .tab.active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Modal & Toast Styles */
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .toast {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <!-- Background decorations -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute -top-40 -left-40 w-96 h-96 bg-emerald-200/40 rounded-full filter blur-3xl opacity-50 animate-pulse"></div>
        <div class="absolute -bottom-40 -right-40 w-96 h-96 bg-sky-200/40 rounded-full filter blur-3xl opacity-50"></div>
    </div>

    <div id="app" class="min-h-screen p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 max-w-7xl mx-auto flex justify-between items-center">
             <a href="index.html" class="flex items-center gap-3 group w-fit">
                <i class="ph-bold ph-leaf text-4xl text-emerald-600 group-hover:animate-spin"></i>
                <div>
                    <h1 class="text-3xl font-bold">EcoHub</h1>
                    <p class="text-gray-500">The Ultimate Energy & Savings Hub</p>
                </div>
            </a>
            <button id="open-log-modal-btn" class="btn-primary flex items-center gap-2">
                <i class="ph-bold ph-plus-circle text-xl"></i> Log Today's Usage
            </button>
        </header>

        <main class="max-w-7xl mx-auto">
            <!-- Tabs Navigation -->
            <div class="mb-6 bg-white/50 backdrop-blur-sm p-2 rounded-xl inline-flex gap-2 border flex-wrap">
                <button class="tab active font-semibold py-2 px-5 rounded-lg" data-tab="dashboard">Dashboard</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="eco-coach">EcoCoach AI</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="community">Community</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="goals">Goals</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="reports">Reports</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="achievements">Achievements</button>
                <button class="tab font-semibold py-2 px-5 rounded-lg" data-tab="settings">Settings</button>
            </div>

            <!-- Tab Content -->
            <div id="dashboard-tab" class="tab-content active fade-in-up">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <section class="glass-card p-6">
                             <h2 class="text-2xl font-bold mb-4">Today's Impact Summary</h2>
                             <p id="results-subtitle" class="text-gray-600 mb-6 text-sm">Log your usage to see your savings for today.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                                <div class="bg-emerald-50 p-4 rounded-xl"><p class="text-sm text-emerald-800 font-medium">Energy Saved</p><p id="energy-saved-result" class="text-4xl font-bold text-emerald-600">0.00</p><p class="text-xs text-emerald-500">kWh</p></div>
                                <div class="bg-sky-50 p-4 rounded-xl"><p class="text-sm text-sky-800 font-medium">Money Saved</p><p id="money-saved-result" class="text-4xl font-bold text-sky-600">0.00</p><p class="text-xs text-sky-500">INR</p></div>
                                 <div class="bg-gray-100 p-4 rounded-xl"><p class="text-sm text-gray-800 font-medium">COâ‚‚ Reduction</p><p id="co2-reduced-result" class="text-4xl font-bold text-gray-700">0.00</p><p class="text-xs text-gray-500">kg</p></div>
                            </div>
                        </section>
                        <section class="glass-card p-6"><h2 class="text-2xl font-bold mb-4">Your 7-Day Energy Trend</h2><div class="h-64"><canvas id="energy-chart"></canvas></div></section>
                    </div>
                    <div class="space-y-8">
                        <section class="glass-card p-6"><h2 class="text-2xl font-bold mb-4">Weekly Goal</h2><p class="text-sm text-gray-600 mb-2">Target: <span id="goal-target-summary" class="font-bold">Not set</span></p><div class="w-full bg-gray-200 rounded-full h-4 mb-2"><div id="goal-progress-bar-summary" class="bg-blue-500 h-4 rounded-full" style="width: 0%"></div></div><p id="goal-status-summary" class="text-sm text-gray-600">Set a goal to start tracking.</p></section>
                         <section class="glass-card p-6"><h2 class="text-2xl font-bold mb-4">Quick Stats</h2><div class="space-y-3"><div><p class="font-semibold">All-Time Savings</p><p id="all-time-savings-stat" class="text-blue-600 font-bold text-2xl">0.00 kWh</p></div><div><p class="font-semibold">Best Day (Lowest Use)</p><p id="best-day-stat" class="text-emerald-600 font-bold text-2xl">N/A</p></div><div><p class="font-semibold">Consecutive Days Logged</p><p id="streak-stat" class="text-orange-500 font-bold text-2xl">0</p></div></div></section>
                    </div>
                </div>
            </div>

            <div id="eco-coach-tab" class="tab-content fade-in-up">
                <section class="glass-card p-8">
                    <div class="text-center mb-8">
                        <i class="ph-bold ph-robot text-6xl text-blue-500"></i>
                        <h2 class="text-3xl font-bold mt-2">EcoCoach AI</h2>
                        <p class="text-gray-600">Your personal energy saving assistant.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white/80 p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-3">Personalized Tip of the Day</h3>
                            <p id="eco-coach-tip" class="text-gray-700">Log your usage to get your first tip!</p>
                        </div>
                        <div class="bg-white/80 p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-3">Your Weekly Report Card</h3>
                            <p id="eco-coach-summary" class="text-gray-700">Not enough data for a weekly summary yet. Keep logging!</p>
                        </div>
                        <div class="md:col-span-2 bg-emerald-50 p-6 rounded-xl text-center">
                             <h3 class="text-xl font-bold mb-3">Did You Know?</h3>
                             <p id="eco-coach-fact" class="text-emerald-800 italic"></p>
                        </div>
                    </div>
                </section>
            </div>
            
            <div id="community-tab" class="tab-content fade-in-up">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <section class="glass-card p-8">
                        <h2 class="text-2xl font-bold mb-4">Community Challenge</h2>
                        <p class="text-gray-600 mb-2">Help us collectively save <strong class="text-emerald-600">1,000 kWh</strong> this month!</p>
                        <div class="w-full bg-gray-200 rounded-full h-6 mb-2">
                            <div id="community-goal-progress-bar" class="bg-gradient-to-r from-emerald-400 to-green-500 h-6 rounded-full flex items-center justify-center text-white font-bold text-sm" style="width: 0%">0%</div>
                        </div>
                        <p id="community-goal-status" class="text-sm text-gray-600 text-center">Let's get started!</p>
                    </section>
                     <section class="glass-card p-8">
                        <h2 class="text-2xl font-bold mb-4">Weekly Savings Leaderboard</h2>
                        <div id="leaderboard-container" class="space-y-3">
                            <!-- JS will populate this -->
                        </div>
                    </section>
                </div>
            </div>

            <div id="goals-tab" class="tab-content fade-in-up">
                <section class="glass-card p-8 max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-4">Set & Track Your Weekly Goal</h2><p class="text-gray-600 mb-6">Challenge yourself by setting a weekly energy consumption target.</p><div class="mb-6"><label for="goal-input" class="block text-sm font-medium text-gray-700 mb-2">Weekly Consumption Goal (kWh)</label><div class="flex gap-4"><input type="number" id="goal-input" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="e.g., 50"><button id="set-goal-btn" class="btn-primary">Set Goal</button></div></div><div><h3 class="text-xl font-bold mb-2">Your Progress</h3><p class="text-sm text-gray-600 mb-2">Target: <span id="goal-target-detail" class="font-bold">Not set</span> | Used this week: <span id="goal-used-detail" class="font-bold">0.00 kWh</span></p><div class="w-full bg-gray-200 rounded-full h-6"><div id="goal-progress-bar-detail" class="bg-gradient-to-r from-green-400 to-blue-500 h-6 rounded-full flex items-center justify-center text-white font-bold text-sm" style="width: 0%">0%</div></div><p id="goal-status-detail" class="text-center mt-3 text-gray-600">Set a goal to begin.</p></div></section>
            </div>

            <div id="reports-tab" class="tab-content fade-in-up">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <section class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-6">Detailed History</h2>
                        <div id="history-table-container" class="max-h-96 overflow-y-auto"></div>
                    </section>
                    <section class="glass-card p-6">
                        <h2 class="text-2xl font-bold mb-6">Usage Breakdown by Device</h2>
                        <p class="text-sm text-gray-500 mb-4">Analysis of your most recent logged day.</p>
                        <div class="h-80"><canvas id="device-pie-chart"></canvas></div>
                    </section>
                </div>
            </div>

            <div id="achievements-tab" class="tab-content fade-in-up">
                <section class="glass-card p-8">
                    <h2 class="text-2xl font-bold mb-6">Your Achievements</h2>
                    <div id="achievements-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6"></div>
                </section>
            </div>

            <div id="settings-tab" class="tab-content fade-in-up">
                <section class="glass-card p-8 max-w-2xl mx-auto space-y-8">
                    <div><h2 class="text-2xl font-bold mb-4">Calculation Settings</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Cost per kWh (INR)</label><input type="number" id="setting-cost" class="w-full p-2 border border-gray-300 rounded-lg"></div><div><label class="block text-sm font-medium">COâ‚‚ per kWh (kg)</label><input type="number" id="setting-co2" class="w-full p-2 border border-gray-300 rounded-lg"></div></div></div>
                    <div><h2 class="text-2xl font-bold mb-4">Custom Devices</h2><div id="custom-device-list" class="space-y-2 mb-4"></div><form id="add-device-form" class="flex gap-4"><input type="text" id="custom-device-name" placeholder="Device Name" class="w-full p-2 border rounded-lg"><input type="number" id="custom-device-wattage" placeholder="Wattage" class="w-1/3 p-2 border rounded-lg"><button type="submit" class="btn-primary px-4 py-2 text-sm">Add</button></form></div>
                    <div><h2 class="text-2xl font-bold mb-4">Data Management</h2><div class="flex gap-4"><button id="export-csv-btn" class="font-semibold text-blue-600">Export History to CSV</button><button id="reset-data-btn" class="font-semibold text-red-500">Reset All Data</button></div></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Log Usage Modal -->
    <div id="log-usage-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-overlay opacity-0">
        <div class="glass-card p-6 w-full max-w-lg modal-content opacity-0 transform scale-95"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Log Your Daily Usage</h2><button id="close-log-modal-btn" class="text-gray-500 hover:text-gray-800"><i class="ph-bold ph-x text-2xl"></i></button></div><form id="device-form" class="space-y-4"><div id="device-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div><div class="p-2 bg-blue-50 rounded-lg text-center font-bold text-blue-700">Total for this entry: <span id="modal-kwh-total">0.00</span> kWh</div><button type="button" id="add-device-btn" class="w-full flex items-center justify-center gap-2 py-2 px-4 border-2 border-dashed border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100/50 hover:border-gray-400 transition"><i class="ph-bold ph-plus-circle"></i> Add Device</button><button type="submit" id="save-log-btn" class="btn-primary w-full" disabled>Calculate & Save</button></form></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-8 right-8 bg-gray-800 text-white p-4 rounded-lg shadow-lg flex items-center gap-3 z-50">
        <i id="toast-icon" class="ph-bold ph-check-circle text-2xl text-green-400"></i>
        <span id="toast-message"></span>
    </div>

<script>
// Logic encapsulated in an IIFE to avoid polluting the global scope
(() => {
    document.addEventListener('DOMContentLoaded', () => {
        // --- CENTRALIZED STATE & DEFAULTS ---
        const AppState = {
            history: [],
            goal: null,
            settings: {
                costPerKwh: 8,
                co2PerKwh: 0.82,
                customDevices: {}
            },
            achievements: []
        };

        const ACHIEVEMENT_DEFS = {
            FIRST_LOG: { id: 'FIRST_LOG', title: "First Step", desc: "Log your first day of usage.", icon: "ph-footprints" },
            STREAK_3: { id: 'STREAK_3', title: "On a Roll", desc: "Log usage for 3 days in a row.", icon: "ph-fire" },
            STREAK_7: { id: 'STREAK_7', title: "Weekly Warrior", desc: "Log usage for 7 days in a row.", icon: "ph-calendar-check" },
            SAVE_10_KWH: { id: 'SAVE_10_KWH', title: "Energy Saver", desc: "Save a total of 10 kWh.", icon: "ph-plugs" },
            SAVE_50_KWH: { id: 'SAVE_50_KWH', title: "Conservationist", desc: "Save a total of 50 kWh.", icon: "ph-tree-evergreen" },
            GOAL_SET: { id: 'GOAL_SET', title: "Goal Setter", desc: "Set your first weekly goal.", icon: "ph-flag-checkered" },
        };
        
        const ECO_COACH_TIPS = {
            'AC (1.5 Ton)': "Your AC usage is high. Try setting the thermostat a degree higher or using a timer to reduce consumption overnight.",
            'Lift': "Lifts are energy-intensive. Consider taking the stairs for short trips to save power and get some exercise!",
            'Projector': "Projectors consume significant energy. Ensure they're turned off completely when not in use, as standby mode still draws power.",
            'Computer': "High computer usage. Remember to use sleep mode for short breaks and shut down fully at the end of the day.",
            'DEFAULT': "Great job logging today! A simple tip: unplug chargers and appliances when not in use, as they can draw 'phantom power'."
        };
        
        const ECO_COACH_FACTS = [
            "A single LED bulb is 80% more efficient than a traditional incandescent bulb.",
            "Phantom power from idle electronics can account for up to 10% of household energy use.",
            "For every degree you raise your AC's thermostat in summer, you can save up to 3% on your cooling bill.",
            "India has one of the world's largest renewable energy expansion programs.",
            "Saving just 1 kWh of electricity prevents about 0.82 kg of COâ‚‚ from entering the atmosphere."
        ];

        let energyChart = null;
        let devicePieChart = null;
        
        // --- DOM ELEMENT SELECTORS ---
        const DOMElements = {
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            modal: document.getElementById('log-usage-modal'),
            modalOverlay: document.querySelector('#log-usage-modal .modal-overlay'),
            modalContent: document.querySelector('#log-usage-modal .modal-content'),
            openModalBtn: document.getElementById('open-log-modal-btn'),
            closeModalBtn: document.getElementById('close-log-modal-btn'),
            deviceList: document.getElementById('device-list'),
            addDeviceBtn: document.getElementById('add-device-btn'),
            deviceForm: document.getElementById('device-form'),
            saveLogBtn: document.getElementById('save-log-btn'),
            modalKwhTotal: document.getElementById('modal-kwh-total'),
        };

        // --- STATE MANAGEMENT ---
        const loadState = () => {
            try {
                const history = JSON.parse(localStorage.getItem('ecoHubHistory') || '[]');
                const goal = JSON.parse(localStorage.getItem('ecoHubGoal') || 'null');
                const settings = JSON.parse(localStorage.getItem('ecoHubSettings') || 'null');
                const achievements = JSON.parse(localStorage.getItem('ecoHubAchievements') || '[]');
                
                AppState.history = history;
                AppState.goal = goal;
                AppState.achievements = achievements;
                if (settings) AppState.settings = { ...AppState.settings, ...settings };

            } catch (error) {
                console.error("Failed to load state from localStorage:", error);
                localStorage.clear();
            }
        };

        const commitState = () => {
            try {
                localStorage.setItem('ecoHubHistory', JSON.stringify(AppState.history));
                localStorage.setItem('ecoHubGoal', JSON.stringify(AppState.goal));
                localStorage.setItem('ecoHubSettings', JSON.stringify(AppState.settings));
                localStorage.setItem('ecoHubAchievements', JSON.stringify(AppState.achievements));
            } catch (error) {
                console.error("Failed to save state to localStorage:", error);
                showToast("Could not save data. Your browser's storage might be full or in private mode.", "error");
            }
        };
        
        // --- CORE APPLICATION LOGIC ---
        function handleCalculation(e) {
            e.preventDefault();
            const { totalKWh, deviceBreakdown } = calculateModalKwh();
            
            const todayStr = new Date().toISOString().split('T')[0];
            const todayEntryIndex = AppState.history.findIndex(entry => entry.date === todayStr);

            if (todayEntryIndex > -1) {
                AppState.history[todayEntryIndex] = { date: todayStr, kwh: totalKWh, breakdown: deviceBreakdown };
            } else {
                AppState.history.push({ date: todayStr, kwh: totalKWh, breakdown: deviceBreakdown });
            }
            
            checkAchievements();
            commitState();
            renderAll();
            closeModal();
            showToast("Today's usage logged successfully!", "success");
        }

        function handleSetGoal() {
            const goalInput = document.getElementById('goal-input');
            const goalValue = parseFloat(goalInput.value);
            if (!isNaN(goalValue) && goalValue > 0) {
                AppState.goal = goalValue;
                checkAchievements();
                commitState();
                renderAll();
                goalInput.value = '';
                showToast("New goal has been set!", "success");
            } else {
                showToast("Please enter a valid, positive number.", "error");
            }
        }
        
        function handleResetData() {
            if (confirm("Are you sure? This will delete all your data permanently.")) {
                localStorage.clear();
                AppState.history = [];
                AppState.goal = null;
                AppState.achievements = [];
                renderAll();
                showToast("All data has been reset.", "info");
            }
        }

        function handleAddCustomDevice(e) {
            e.preventDefault();
            const nameInput = document.getElementById('custom-device-name');
            const wattageInput = document.getElementById('custom-device-wattage');
            const name = nameInput.value.trim();
            const wattage = parseFloat(wattageInput.value);

            if (name && !isNaN(wattage) && wattage > 0) {
                AppState.settings.customDevices[name] = wattage;
                commitState();
                renderAll();
                nameInput.value = '';
                wattageInput.value = '';
                showToast(`Custom device "${name}" added.`, "success");
            } else {
                showToast("Invalid device name or wattage.", "error");
            }
        }
        
        function checkAchievements() {
            const newAchievements = [];
            if (AppState.history.length >= 1 && !AppState.achievements.includes('FIRST_LOG')) newAchievements.push('FIRST_LOG');
            if (AppState.goal && !AppState.achievements.includes('GOAL_SET')) newAchievements.push('GOAL_SET');
            
            const streak = calculateStreak();
            if (streak >= 3 && !AppState.achievements.includes('STREAK_3')) newAchievements.push('STREAK_3');
            if (streak >= 7 && !AppState.achievements.includes('STREAK_7')) newAchievements.push('STREAK_7');

            const allTimeSavings = calculateAllTimeSavings();
            if (allTimeSavings >= 10 && !AppState.achievements.includes('SAVE_10_KWH')) newAchievements.push('SAVE_10_KWH');
            if (allTimeSavings >= 50 && !AppState.achievements.includes('SAVE_50_KWH')) newAchievements.push('SAVE_50_KWH');
            
            if (newAchievements.length > 0) {
                AppState.achievements.push(...newAchievements);
                const latestAchievement = ACHIEVEMENT_DEFS[newAchievements[0]];
                showToast(`Achievement Unlocked: ${latestAchievement.title}!`, "achievement", latestAchievement.icon);
            }
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        const getFullDeviceMap = () => ({
            'Fan': 75, 'Light Bulb (LED)': 10, 'Projector': 300, 
            'AC (1.5 Ton)': 1500, 'Computer': 250, 'Lift': 5000, 'Other': 100,
            ...AppState.settings.customDevices
        });

        const calculateStreak = () => {
            if (AppState.history.length < 1) return 0;
            let streak = 0;
            const sortedDates = AppState.history.map(e => new Date(e.date)).sort((a, b) => b - a);
            
            let today = new Date();
            today.setHours(0,0,0,0);
            
            if(sortedDates[0].getTime() === today.getTime() || sortedDates[0].getTime() === today.getTime() - 86400000){
                streak = 1;
                for (let i = 0; i < sortedDates.length - 1; i++) {
                    const diff = sortedDates[i].getTime() - sortedDates[i+1].getTime();
                    if (diff === 86400000) streak++; else break;
                }
            }
            return streak;
        };
        
        const calculateAllTimeSavings = () => AppState.history.reduce((total, entry, index, arr) => {
            if (index === 0) return 0;
            const pastAvg = arr.slice(0, index).reduce((s, e) => s + e.kwh, 0) / index;
            return total + Math.max(0, pastAvg - entry.kwh);
        }, 0);

        const calculateModalKwh = () => {
            let totalKWh = 0;
            const deviceBreakdown = {};
            const deviceMap = getFullDeviceMap();
            DOMElements.deviceList.querySelectorAll('.device-row').forEach(row => {
                const type = row.querySelector('.device-type').value;
                const count = parseFloat(row.querySelector('.device-count').value) || 0;
                const hours = parseFloat(row.querySelector('.device-hours').value) || 0;
                const kwh = (deviceMap[type] * count * hours) / 1000;
                totalKWh += kwh;
                deviceBreakdown[type] = (deviceBreakdown[type] || 0) + kwh;
            });
            return { totalKWh, deviceBreakdown };
        }

        // --- DYNAMIC RENDERING & UI ---
        const renderAll = () => {
            renderDashboard();
            renderGoals();
            renderReports();
            renderAchievements();
            renderSettings();
            renderChart();
            renderDevicePieChart();
            renderCommunity();
            renderEcoCoach();
        };
        
        // Individual Render Functions
        function renderDashboard() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayEntry = AppState.history.find(e => e.date === todayStr);
            let savedKWh = 0, subtitle = "Log today's usage to see your impact.";

            if (todayEntry) {
                const pastEntries = AppState.history.filter(e => e.date !== todayStr);
                let averageKWh = pastEntries.length > 0 ? pastEntries.reduce((s, e) => s + e.kwh, 0) / pastEntries.length : todayEntry.kwh * 1.15;
                subtitle = pastEntries.length > 0 ? `Compared to your historical average of ${averageKWh.toFixed(2)} kWh/day.` : "Great start! This is your first logged day.";
                savedKWh = Math.max(0, averageKWh - todayEntry.kwh);
            }
            
            document.getElementById('energy-saved-result').textContent = savedKWh.toFixed(2);
            document.getElementById('money-saved-result').textContent = (savedKWh * AppState.settings.costPerKwh).toFixed(2);
            document.getElementById('co2-reduced-result').textContent = (savedKWh * AppState.settings.co2PerKwh).toFixed(2);
            document.getElementById('results-subtitle').textContent = subtitle;

            document.getElementById('all-time-savings-stat').textContent = `${calculateAllTimeSavings().toFixed(2)} kWh`;
            const bestDay = AppState.history.reduce((min, entry) => (entry.kwh < min.kwh ? entry : min), { kwh: Infinity });
            document.getElementById('best-day-stat').textContent = bestDay.kwh === Infinity ? 'N/A' : `${bestDay.kwh.toFixed(2)} kWh`;
            document.getElementById('streak-stat').textContent = calculateStreak();
        }

        function renderGoals() {
            const goal = AppState.goal;
            const goalTargetSum = document.getElementById('goal-target-summary'), goalBarSum = document.getElementById('goal-progress-bar-summary'), goalStatusSum = document.getElementById('goal-status-summary');
            const goalTargetDet = document.getElementById('goal-target-detail'), goalUsedDet = document.getElementById('goal-used-detail'), goalBarDet = document.getElementById('goal-progress-bar-detail'), goalStatusDet = document.getElementById('goal-status-detail');
            
            if (goal) {
                const now = new Date();
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - (now.getDay() + 6) % 7);
                startOfWeek.setHours(0, 0, 0, 0);

                const usedThisWeek = AppState.history.filter(e => new Date(e.date) >= startOfWeek).reduce((sum, e) => sum + e.kwh, 0);
                const progress = Math.min(100, (usedThisWeek / goal) * 100);

                [goalTargetSum, goalTargetDet].forEach(el => el.textContent = `${goal} kWh`);
                [goalBarSum, goalBarDet].forEach(el => { el.style.width = `${progress}%`; if (el.id.includes('detail')) el.textContent = `${Math.round(progress)}%`; });
                goalStatusSum.textContent = `Used ${usedThisWeek.toFixed(2)} of ${goal} kWh this week.`;
                goalUsedDet.textContent = `${usedThisWeek.toFixed(2)} kWh`;
                goalStatusDet.textContent = `You've used ${Math.round(progress)}% of your weekly budget.`;
            } else {
                [goalTargetSum, goalTargetDet].forEach(el => el.textContent = 'Not set');
                [goalBarSum, goalBarDet].forEach(el => { el.style.width = '0%'; if (el.id.includes('detail')) el.textContent = '0%'; });
                [goalStatusSum, goalStatusDet].forEach(el => el.textContent = "Set a goal to start tracking.");
            }
        }
        
        function renderCommunity() {
            // Simulated community data
            const communitySavings = AppState.history.reduce((sum, e) => sum + e.kwh, 0) * 15; // Simulate a larger community
            const communityGoal = 1000;
            const progress = Math.min(100, (communitySavings / communityGoal) * 100);
            document.getElementById('community-goal-progress-bar').style.width = `${progress}%`;
            document.getElementById('community-goal-progress-bar').textContent = `${Math.round(progress)}%`;
            document.getElementById('community-goal-status').textContent = `We've collectively saved ${communitySavings.toFixed(2)} kWh so far!`;

            // Simulated leaderboard
            const leaderboardContainer = document.getElementById('leaderboard-container');
            const yourWeeklySavings = AppState.history.filter(e => new Date(e.date) >= new Date(new Date().setDate(new Date().getDate() - 7))).reduce((sum, e) => sum + e.kwh, 0);
            const leaderboardData = [
                { name: 'User A', savings: (yourWeeklySavings * 1.8).toFixed(2) },
                { name: 'User B', savings: (yourWeeklySavings * 1.5).toFixed(2) },
                { name: 'You', savings: yourWeeklySavings.toFixed(2) },
                { name: 'User C', savings: (yourWeeklySavings * 0.9).toFixed(2) },
                { name: 'User D', savings: (yourWeeklySavings * 0.7).toFixed(2) },
            ].sort((a, b) => b.savings - a.savings);
            
            leaderboardContainer.innerHTML = leaderboardData.map((user, index) => `
                <div class="flex items-center justify-between p-2 rounded-lg ${user.name === 'You' ? 'bg-blue-100' : ''}">
                    <span class="font-semibold">${index + 1}. ${user.name}</span>
                    <span class="font-bold text-blue-600">${user.savings} kWh saved</span>
                </div>
            `).join('');
        }

        function renderEcoCoach() {
            const tipEl = document.getElementById('eco-coach-tip');
            const summaryEl = document.getElementById('eco-coach-summary');
            const factEl = document.getElementById('eco-coach-fact');
            const latestEntry = AppState.history[AppState.history.length - 1];

            if (latestEntry && latestEntry.breakdown) {
                const topDevice = Object.entries(latestEntry.breakdown).sort((a,b) => b[1] - a[1])[0][0];
                tipEl.textContent = ECO_COACH_TIPS[topDevice] || ECO_COACH_TIPS['DEFAULT'];
            }
            
            const weeklyHistory = AppState.history.slice(-7);
            if (weeklyHistory.length >= 2) {
                const avg = weeklyHistory.reduce((s,e) => s + e.kwh, 0) / weeklyHistory.length;
                const trend = weeklyHistory[weeklyHistory.length-1].kwh - weeklyHistory[0].kwh;
                summaryEl.textContent = `Your average usage this week was ${avg.toFixed(2)} kWh/day. Your consumption trend is ${trend > 0 ? 'increasing' : 'decreasing'}. Keep up the great work!`;
            }

            factEl.textContent = ECO_COACH_FACTS[new Date().getDate() % ECO_COACH_FACTS.length];
        }

        function renderReports() {
            const tableContainer = document.getElementById('history-table-container');
            if (AppState.history.length > 0) {
                tableContainer.innerHTML = `<table class="w-full text-left"><thead class="sticky top-0 bg-white/80 backdrop-blur-sm"><tr><th class="p-3">Date</th><th class="p-3">Consumption (kWh)</th></tr></thead><tbody>${AppState.history.slice().reverse().map(entry => `<tr class="border-b border-gray-200"><td class="p-3">${new Date(entry.date).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' })}</td><td class="p-3 font-semibold">${entry.kwh.toFixed(2)}</td></tr>`).join('')}</tbody></table>`;
            } else {
                tableContainer.innerHTML = '<p class="text-center p-6 text-gray-500">No data logged yet.</p>';
            }
        }
        
        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = Object.values(ACHIEVEMENT_DEFS).map(ach => `
                <div class="text-center p-4 rounded-xl ${AppState.achievements.includes(ach.id) ? 'bg-green-100' : 'bg-gray-100 opacity-60'}">
                    <i class="ph-bold ${ach.icon} text-4xl ${AppState.achievements.includes(ach.id) ? 'text-green-500' : 'text-gray-400'}"></i>
                    <h4 class="font-bold mt-2">${ach.title}</h4>
                    <p class="text-xs text-gray-600">${ach.desc}</p>
                </div>
            `).join('');
        }

        function renderSettings() {
            document.getElementById('setting-cost').value = AppState.settings.costPerKwh;
            document.getElementById('setting-co2').value = AppState.settings.co2PerKwh;
            const customList = document.getElementById('custom-device-list');
            customList.innerHTML = Object.entries(AppState.settings.customDevices).map(([name, wattage]) => `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                    <span><strong>${name}</strong>: ${wattage}W</span>
                    <button data-name="${name}" class="remove-custom-device-btn text-red-500 hover:text-red-700 text-xl font-bold">&times;</button>
                </div>
            `).join('');
        }
        
        function renderChart() {
            const history = AppState.history.slice(-7);
            if(energyChart) energyChart.destroy();
            energyChart = new Chart(document.getElementById('energy-chart'), {
                type: 'line', data: { labels: history.map(e => new Date(e.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })), datasets: [{ label: 'kWh Usage', data: history.map(e => e.kwh), backgroundColor: 'rgba(37, 99, 235, 0.1)', borderColor: 'rgba(37, 99, 235, 1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }
        
        function renderDevicePieChart() {
            const latestEntry = AppState.history[AppState.history.length - 1];
            if(devicePieChart) devicePieChart.destroy();
            const canvas = document.getElementById('device-pie-chart');
            if (latestEntry && latestEntry.breakdown && Object.keys(latestEntry.breakdown).length > 0) {
                 devicePieChart = new Chart(canvas, {
                    type: 'doughnut',
                    data: { labels: Object.keys(latestEntry.breakdown), datasets: [{ data: Object.values(latestEntry.breakdown) }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                });
            } else {
                 const ctx = canvas.getContext('2d');
                 ctx.clearRect(0,0,canvas.width,canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText('Log usage to see breakdown', canvas.width/2, canvas.height/2);
            }
        }
        
        // --- EVENT HANDLERS ---
        function setupEventListeners() {
            DOMElements.tabs.forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
            DOMElements.openModalBtn.addEventListener('click', openModal);
            DOMElements.closeModalBtn.addEventListener('click', closeModal);
            DOMElements.modalOverlay.addEventListener('click', (e) => { if (e.target === DOMElements.modalOverlay) closeModal(); });
            DOMElements.addDeviceBtn.addEventListener('click', addDeviceRow);
            DOMElements.deviceForm.addEventListener('submit', handleCalculation);
            document.getElementById('set-goal-btn').addEventListener('click', handleSetGoal);
            document.getElementById('add-device-form').addEventListener('submit', handleAddCustomDevice);
            
            document.getElementById('settings-tab').addEventListener('click', e => {
                if(e.target.matches('.remove-custom-device-btn')) {
                    delete AppState.settings.customDevices[e.target.dataset.name];
                    commitState(); renderAll();
                }
            });
            document.getElementById('settings-tab').addEventListener('change', e => {
                if(e.target.id === 'setting-cost') AppState.settings.costPerKwh = parseFloat(e.target.value) || 8;
                if(e.target.id === 'setting-co2') AppState.settings.co2PerKwh = parseFloat(e.target.value) || 0.82;
                commitState(); renderAll();
            });

            DOMElements.deviceList.addEventListener('input', () => {
                const { totalKWh } = calculateModalKwh();
                DOMElements.modalKwhTotal.textContent = totalKWh.toFixed(2);
                DOMElements.saveLogBtn.disabled = totalKWh <= 0;
            });
            
             document.getElementById('reset-data-btn').addEventListener('click', handleResetData);
             document.getElementById('export-csv-btn').addEventListener('click', exportCSV);
        }
        
        function switchTab(activeTab) {
            DOMElements.tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === activeTab));
            DOMElements.tabContents.forEach(content => content.classList.toggle('active', content.id === `${activeTab}-tab`));
        }
        
        function openModal() {
            DOMElements.modal.classList.remove('hidden');
            setTimeout(() => {
                DOMElements.modalOverlay.classList.remove('opacity-0');
                DOMElements.modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);
        }

        function closeModal() {
            DOMElements.modalOverlay.classList.add('opacity-0');
            DOMElements.modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOMElements.modal.classList.add('hidden');
                DOMElements.deviceList.innerHTML = '';
                addDeviceRow();
            }, 300);
        }

        function addDeviceRow() {
            const row = document.createElement('div');
            const deviceMap = getFullDeviceMap();
            row.className = 'device-row grid grid-cols-4 gap-2 items-center fade-in-up';
            row.innerHTML = `<select class="device-type col-span-2 w-full p-2 bg-white/80 border border-gray-300 rounded-md text-sm">${Object.keys(deviceMap).map(d => `<option value="${d}">${d}</option>`).join('')}</select><input type="number" class="device-count w-full p-2 bg-white/80 border border-gray-300 rounded-md text-sm" placeholder="Qty" min="1" value="1"><div class="flex items-center"><input type="number" class="device-hours w-full p-2 bg-white/80 border border-gray-300 rounded-md text-sm" placeholder="Hrs" min="0" step="0.1" required><button type="button" class="remove-device-btn text-red-500 hover:text-red-700 p-1 ml-1"><i class="ph-bold ph-trash"></i></button></div>`;
            DOMElements.deviceList.appendChild(row);
            row.querySelector('.remove-device-btn').addEventListener('click', () => {
                row.remove();
                DOMElements.deviceList.dispatchEvent(new Event('input'));
            });
            DOMElements.deviceList.dispatchEvent(new Event('input'));
        }

        function showToast(message, type = "info", iconClass = "ph-info") {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            document.getElementById('toast-message').textContent = message;

            toastIcon.className = `ph-bold text-2xl ${
                type === 'success' ? 'ph-check-circle text-green-400' : 
                type === 'error' ? 'ph-x-circle text-red-400' :
                type === 'achievement' ? `${iconClass} text-yellow-400` :
                'ph-info text-blue-400'
            }`;

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }
        
        function exportCSV() {
            if (AppState.history.length === 0) {
                showToast("No data to export.", "info");
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,Date,Consumption (kWh)\n";
            AppState.history.forEach(row => {
                csvContent += `${row.date},${row.kwh}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "ecohub_history.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- APPLICATION ENTRY POINT ---
        loadState();
        setupEventListeners();
        renderAll();
    });
})();
</script>
</body>
</html>

